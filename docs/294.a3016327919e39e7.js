"use strict";(self.webpackChunkpoetry_gen=self.webpackChunkpoetry_gen||[]).push([[294],{5294:(Z,A,E)=>{E.r(A),E.d(A,{TonematrixModule:()=>H});var D=E(6895),O=E(3327);class F{constructor(){this.data=new Uint32Array(16)}serialize(){let n=[];for(let t=0;t<16;t++)n.push(this.data[t].toString(32));return n.join(".")}deserialize(n){try{n.split(".").map(t=>parseInt(t,32)).forEach((t,e)=>this.data[e]=t)}catch{}}setStep(n,t,e){e?this.data[t]|=1<<n:this.data[t]&=~(1<<n)}getStep(n,t){return 0!=(this.data[t]&1<<n)}clear(){this.data.fill(0)}}class k{constructor(){this.pattern=new F,this.stepIndex=0}}class C{static fill(n,t){const e=[];for(let i=0;i<n;i++)e[i]=t(i);return e}constructor(){}}const m=16,f=16;class T{constructor(n,t){this.model=n,this.canvas=t,this.graphics=this.canvas.getContext("2d"),this.stepTextureOn=T.createStepTexture("#FFFFFF","#DADADA"),this.stepTextureOff=T.createStepTexture("#4F4F4F","#2A2A2A"),this.wavesData=new ImageData(m,f),this.waves=T.create2dContext(m),this.fluidMaps=[C.fill(m,()=>new Float32Array(m)),C.fill(f,()=>new Float32Array(f))],this.fluidMapIndex=0,this.stepIndex=-1,this.processAnimationFrame=()=>{this.touchActives(),this.processFluid(),this.graphics.imageSmoothingEnabled=!1,this.graphics.clearRect(0,0,512,512);for(let e=0;e<f;e++)for(let i=0;i<m;i++){const o=this.model.pattern.getStep(i,e)?this.stepTextureOn:this.stepTextureOff;this.graphics.drawImage(o,i<<5,e<<5)}this.graphics.save(),this.graphics.globalCompositeOperation="lighter",this.graphics.drawImage(this.waves.canvas,0,0,512,512),this.graphics.restore(),requestAnimationFrame(this.processAnimationFrame)},this.canvas.width=512,this.canvas.height=512,this.initEvents(),this.processAnimationFrame(),this.setSequenceByStepAndStartInterval(2,0,4,0),this.setSequenceByStepAndStartInterval(4,0,4,0)}setSequenceByStepAndStartInterval(n=4,t=0,e=4,i=0){let o=n,l=e,d=15;for(let u=0;u<16;u+=o)this.setStep(u,d,!0,!1),l=Math.max(1,l-i),o=Math.max(1,o-t),d-=l}initEvents(){let n=!1;const t=e=>{if(e.preventDefault(),"mousemove"===e.type&&!e.buttons)return;const i=this.canvas.getBoundingClientRect();let o,l;if(void 0!==e.targetTouches){const p=e.targetTouches.item(0);o=p.clientX,l=p.clientY}else{if(!(e instanceof MouseEvent))return;o=e.clientX,l=e.clientY}const d=this.canvas.width/i.width,u=(o-i.left)*d>>5,h=(l-i.top)*d>>5;u<0||u>=m||h<0||h>=f||(("mousedown"===e.type||"touchstart"===e.type)&&(n=!this.getStep(u,h)),this.setStep(u,h,n))};this.canvas.addEventListener("mousedown",t),this.canvas.addEventListener("touchstart",t),this.canvas.addEventListener("mousemove",t),this.canvas.addEventListener("touchmove",t),window.addEventListener("pointerdown",e=>{e.target instanceof HTMLButtonElement||e.target===this.canvas||(this.model.pattern.clear(),e.preventDefault())},{capture:!1}),window.addEventListener("keydown",e=>{"Space"===e.code&&this.model.pattern.clear()},{capture:!0})}setStep(n,t,e,i=!0){this.model.pattern.setStep(n,t,e),e&&i&&this.touchFluid(n,t)}touchFluid(n,t){this.fluidMaps[0][t][n]=-1,this.fluidMaps[1][t][n]=-1}getStep(n,t){return this.model.pattern.getStep(n,t)}touchActives(){if(this.stepIndex!==this.model.stepIndex){this.stepIndex=this.model.stepIndex;for(let n=0;n<f;++n)this.model.pattern.getStep(this.stepIndex,n)&&this.touchFluid(this.stepIndex,n)}}processFluid(){const n=this.fluidMaps[this.fluidMapIndex],t=this.fluidMaps[1-this.fluidMapIndex],e=this.wavesData,i=e.data;for(let o=0;o<f;++o){const l=n[o-1],d=n[o],u=n[o+1];for(let h=0;h<m;++h){let p=0;h>0&&(p+=d[h-1]),o>0&&(p+=l[h]),h<15&&(p+=d[h+1]),o<15&&(p+=u[h]),p=.7*(.5*p-t[o][h]),p<-1?p=-1:p>1&&(p=1),t[o][h]=p;const I=Math.max(0,Math.min(128,255*p|0)),b=(o<<4|h)<<2;i[b]=I,i[b+1]=I,i[b+2]=I,i[b+3]=255}}this.fluidMapIndex=1-this.fluidMapIndex,this.waves.putImageData(e,0,0)}static createStepTexture(n,t){const e=T.create2dContext(32);return e.save(),e.fillStyle=n,e.fillRect(1,1,30,30),e.fillStyle=t,e.fillRect(2,2,28,28),e.restore(),e.canvas}static create2dContext(n){const t=document.createElement("canvas");return t.width=t.height=n,t.getContext("2d")}}const s=r=>440*Math.pow(2,(r+3)/12-6);class a{constructor(n){this.model=n,this.context=new AudioContext,this.voiceMix=this.context.createGain(),this.nextScheduleTime=0,this.absoluteTime=0,this.intervalId=-1,this.bpm=120;for(let t=0;t<=16;t++)a.SEMITONES[16-t]=s(t+57);if(this.buildFxChain(),"running"===this.context.state)this.start();else{const t=document.querySelector("div.enabled-audio");t.style.visibility="visible";const e={capture:!0},i=o=>{t.style.visibility="hidden",o.preventDefault(),this.context.resume().then(()=>this.start()),window.removeEventListener("mousedown",i,e),window.removeEventListener("touchstart",i,e)};window.addEventListener("mousedown",i,e),window.addEventListener("touchstart",i,e)}}start(){-1<this.intervalId||(this.absoluteTime=0,this.nextScheduleTime=this.context.currentTime+a.LOOK_AHEAD_TIME,this.intervalId=setInterval(()=>{if(this.context.currentTime+a.LOOK_AHEAD_TIME>=this.nextScheduleTime){const t=this.absoluteTime,e=t+a.SCHEDULE_TIME,i=this.secondsToBars(t),o=this.secondsToBars(e);this.schedule(i,o),this.absoluteTime+=a.SCHEDULE_TIME,this.nextScheduleTime+=a.SCHEDULE_TIME}},1))}stop(){this.pause(),this.absoluteTime=0}pause(){-1!==this.intervalId&&(clearInterval(this.intervalId),this.intervalId=-1)}schedule(n,t){let e=n/a.SEMIQUAVER|0;if(e<0)return;let i=e*a.SEMIQUAVER;for(;i<t;){if(i>=n){const l=this.computeStartOffset(i),d=15&e;for(let u=0;u<16;u++)this.model.pattern.getStep(d,u)&&this.playVoice(l,u)}i=++e*a.SEMIQUAVER}const o=this.secondsToBars(this.absoluteTime+a.SCHEDULE_TIME);this.model.stepIndex=Math.floor(o/a.SEMIQUAVER)-1&15}computeStartOffset(n){return this.nextScheduleTime-this.absoluteTime+this.barsToSeconds(n)+a.ADDITIONAL_LATENCY}barsToSeconds(n){return 240*n/this.bpm}secondsToBars(n){return n*this.bpm/240}playVoice(n,t){const e=this.context,i=n+a.RELEASE_TIME,o=e.createOscillator(),l=e.createGain(),d=e.createStereoPanner();d.pan.value=Math.random()-Math.random(),l.gain.value=a.VOICE_GAIN,l.gain.setValueAtTime(a.VOICE_GAIN,n),l.gain.linearRampToValueAtTime(0,i),o.frequency.value=a.NOTES[t],o.connect(d),d.connect(l),l.connect(this.voiceMix),o.start(n),o.stop(i)}buildFxChain(){const n=this.context.createDelay();n.delayTime.value=this.barsToSeconds(3/16);const t=this.context.createGain();t.gain.value=.4;const e=this.context.createGain();e.gain.value=.1,this.voiceMix.connect(n),n.connect(t),t.connect(n),t.connect(e),e.connect(this.context.destination)}}a.LOOK_AHEAD_TIME=.01,a.SCHEDULE_TIME=.01,a.ADDITIONAL_LATENCY=.005,a.SEMIQUAVER=1/16,a.RELEASE_TIME=.25,a.VOICE_GAIN=9,a.NOTESONE=new Float32Array([s(96),s(93),s(91),s(89),s(86),s(84),s(81),s(79),s(77),s(74),s(72),s(69),s(67),s(65),s(62),s(60),s(59),s(58),s(57),s(56),s(55),s(54),s(53),s(52),s(51),s(50),s(49),s(48),s(47),s(46),s(45),s(44)]),a.SEMITONES=new Float32Array(16),a.NOTES=a.SEMITONES;var c=E(4650);const z=[{path:"",component:(()=>{class r{constructor(){this.model=new k,this.audio=new a(this.model)}ngOnInit(){const t=document.querySelector("canvas#matrix");this.view=new T(this.model,t),""!==location.hash&&this.model.pattern.deserialize(location.hash.substring(1)),document.querySelector("button#link").onclick=i=>{i.preventDefault(),navigator.clipboard.writeText(`https://rostag.github.io/locus-poetica/tonematrix/#${this.model.pattern.serialize()}`)},document.querySelector("button#studio").onclick=i=>{i.preventDefault(),window.open("https://www.audiotool.com/")},document.addEventListener("touchmove",i=>i.preventDefault(),{passive:!1}),document.addEventListener("dblclick",i=>i.preventDefault(),{passive:!1});const e=()=>document.body.style.height=`${window.innerHeight}px`;window.addEventListener("resize",e),e(),requestAnimationFrame(()=>{document.querySelectorAll("body svg.preloader").forEach(i=>i.remove()),document.querySelectorAll("body main").forEach(i=>i.classList.remove("invisible"))})}}return r.\u0275fac=function(t){return new(t||r)},r.\u0275cmp=c.Xpm({type:r,selectors:[["app-tonematrix"]],decls:15,vars:0,consts:[[1,"matrix-wrap"],[1,"enabled-audio"],["id","matrix"],[1,"tone-footer"],["id","link"],["id","studio"],[1,"copy"],["href","https://andremichelle.github.io/tonematrix/"]],template:function(t,e){1&t&&(c.TgZ(0,"div",0)(1,"div",1),c._uU(2,"CLICK TO RUN AUDIO"),c.qZA(),c.TgZ(3,"div"),c._UZ(4,"canvas",2),c.TgZ(5,"footer",3)(6,"button",4),c._uU(7,"Copy Link"),c.qZA(),c.TgZ(8,"button",5),c._uU(9,"Open Audiotool Studio"),c.qZA()()(),c.TgZ(10,"div",6),c._uU(11,"Ported to Angular from original"),c._UZ(12,"br"),c.TgZ(13,"a",7),c._uU(14,"Tonematrix by Andre Michelle"),c.qZA()()())},styles:["[_nghost-%COMP%]{--color: #2A2A2A;--background-color: black;margin:0;padding:16px;overflow:hidden;position:relative;font-family:Open Sans,sans-serif;-webkit-overflow-scrolling:touch;touch-action:manipulation;color:var(--color);background-color:var(--background-color);width:-webkit-fill-available;height:-webkit-fill-available;display:flex;align-items:center;justify-content:center;min-width:100vw;min-height:100vh;min-width:-webkit-fill-available}*[_ngcontent-%COMP%]{user-select:none;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-tap-highlight-color:transparent}.hidden[_ngcontent-%COMP%]{display:none!important}.invisible[_ngcontent-%COMP%]{visibility:hidden!important}.enabled-audio[_ngcontent-%COMP%]{top:16px;text-align:center}canvas[_ngcontent-%COMP%]{width:min(512px,80vmin);height:min(512px,80vmin);filter:blur(1px);position:relative}.tone-footer[_ngcontent-%COMP%]{margin-top:16px;display:flex;justify-content:space-between}.tone-footer[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:inherit;border:none;outline:none;-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:8px;cursor:pointer;background-color:#666;border-radius:1px}footer[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:active{background-color:#0ff}.copy[_ngcontent-%COMP%]{font-size:.6rem;color:#555;text-align:center}.copy[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#999}  .app-footer{display:none}"]}),r})()}];let q=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=c.oAB({type:r}),r.\u0275inj=c.cJS({imports:[O.Bz.forChild(z),O.Bz]}),r})(),H=(()=>{class r{}return r.\u0275fac=function(t){return new(t||r)},r.\u0275mod=c.oAB({type:r}),r.\u0275inj=c.cJS({imports:[D.ez,q]}),r})()}}]);