import{Fb as P,Oa as f,Ob as L,P as T,Pa as E,Qa as D,cb as v,wa as R,xa as b}from"./chunk-YFS674CC.js";var F=class{constructor(){this.data=new Uint32Array(16)}serialize(){let i=[];for(let e=0;e<16;e++)i.push(this.data[e].toString(32));return i.join(".")}deserialize(i){try{i.split(".").map(e=>parseInt(e,32)).forEach((e,t)=>this.data[t]=e)}catch{}}setStep(i,e,t){t?this.data[e]|=1<<i:this.data[e]&=~(1<<i)}getStep(i,e){return(this.data[e]&1<<i)!==0}clear(){this.data.fill(0)}},I=class{constructor(){this.pattern=new F,this.stepIndex=0}};var S=class{static fill(i,e){let t=[];for(let n=0;n<i;n++)t[n]=e(n);return t}constructor(){}};var V=!1,B=!1,u=16,m=16,y=5,g=32,_=32,p=1,N=u*g,k=m*_,G=.7,A=class o{constructor(i,e){this.model=i,this.canvas=e,this.graphics=this.canvas.getContext("2d"),this.stepTextureOn=o.createStepTexture("#FFFFFF","#DADADA"),this.stepTextureOff=o.createStepTexture("#4F4F4F","#2A2A2A"),this.wavesData=new ImageData(u,m),this.waves=o.create2dContext(u),this.fluidMaps=[S.fill(u,()=>new Float32Array(u)),S.fill(m,()=>new Float32Array(m))],this.fluidMapIndex=0,this.stepIndex=-1,this.processAnimationFrame=()=>{if(!B){this.touchActives(),this.processFluid(),this.graphics.imageSmoothingEnabled=!1,this.graphics.clearRect(0,0,N,k);for(let t=0;t<m;t++)for(let n=0;n<u;n++){let a=this.model.pattern.getStep(n,t)?this.stepTextureOn:this.stepTextureOff;this.graphics.drawImage(a,n<<y,t<<y)}this.graphics.save(),this.graphics.globalCompositeOperation="lighter",this.graphics.drawImage(this.waves.canvas,0,0,N,k),this.graphics.restore(),requestAnimationFrame(this.processAnimationFrame)}},this.canvas.width=N,this.canvas.height=k,this.initEvents(),this.processAnimationFrame(),this.setSequenceByStepAndStartInterval(2,0,4,0),this.setSequenceByStepAndStartInterval(4,0,4,0)}setSequenceByStepAndStartInterval(i=4,e=0,t=4,n=0){let a=i,r=t,l=15;for(let h=0;h<16;h+=a)this.setStep(h,l,!0,!1),r=Math.max(1,r-n),a=Math.max(1,a-e),l=l-r}initEvents(){let i=!1,e=t=>{if(t.preventDefault(),t.type==="mousemove"&&!t.buttons)return;let n=this.canvas.getBoundingClientRect(),a,r;if(t.targetTouches!==void 0){let d=t.targetTouches.item(0);a=d.clientX,r=d.clientY}else if(t instanceof MouseEvent)a=t.clientX,r=t.clientY;else return;let l=this.canvas.width/n.width,h=(a-n.left)*l>>y,c=(r-n.top)*l>>y;h<0||h>=u||c<0||c>=m||((t.type==="mousedown"||t.type==="touchstart")&&(i=!this.getStep(h,c)),this.setStep(h,c,i))};this.canvas.addEventListener("mousedown",e),this.canvas.addEventListener("touchstart",e),this.canvas.addEventListener("mousemove",e),this.canvas.addEventListener("touchmove",e),window.addEventListener("pointerdown",t=>{t.target instanceof HTMLButtonElement||t.target===this.canvas||(this.model.pattern.clear(),t.preventDefault())},{capture:!1}),window.addEventListener("keydown",t=>{t.code==="Space"&&this.model.pattern.clear()},{capture:!0})}setStep(i,e,t,n=!0){this.model.pattern.setStep(i,e,t),t&&n&&this.touchFluid(i,e)}touchFluid(i,e){this.fluidMaps[0][e][i]=-1,this.fluidMaps[1][e][i]=-1}getStep(i,e){return this.model.pattern.getStep(i,e)}touchActives(){if(this.stepIndex!==this.model.stepIndex){this.stepIndex=this.model.stepIndex;for(let i=0;i<m;++i)this.model.pattern.getStep(this.stepIndex,i)&&this.touchFluid(this.stepIndex,i)}}processFluid(){if(V)return;let i=this.fluidMaps[this.fluidMapIndex],e=this.fluidMaps[1-this.fluidMapIndex],t=this.wavesData,n=t.data;for(let a=0;a<m;++a){let r=i[a-1],l=i[a],h=i[a+1];for(let c=0;c<u;++c){let d=0;c>0&&(d+=l[c-1]),a>0&&(d+=r[c]),c<u-1&&(d+=l[c+1]),a<m-1&&(d+=h[c]),d=(d*.5-e[a][c])*G,d<-1?d=-1:d>1&&(d=1),e[a][c]=d;let C=Math.max(0,Math.min(128,255*d|0)),M=(a<<4|c)<<2;n[M]=C,n[M+1]=C,n[M+2]=C,n[M+3]=255}}this.fluidMapIndex=1-this.fluidMapIndex,this.waves.putImageData(t,0,0)}static createStepTexture(i,e){let t=o.create2dContext(g);return t.save(),t.fillStyle=i,t.fillRect(p,p,g-p*2,g-p*2),t.fillStyle=e,t.fillRect(p*2,p*2,g-p*4,g-p*4),t.restore(),t.canvas}static create2dContext(i){let e=document.createElement("canvas");return e.width=e.height=i,e.getContext("2d")}};var w=16,U=w-1,j=120,s=o=>440*Math.pow(2,(o+3)/12-6),O=class o{static{this.LOOK_AHEAD_TIME=.01}static{this.SCHEDULE_TIME=.01}static{this.ADDITIONAL_LATENCY=.005}static{this.SEMIQUAVER=1/16}static{this.RELEASE_TIME=.25}static{this.VOICE_GAIN=9}static{this.NOTESONE=new Float32Array([s(96),s(93),s(91),s(89),s(86),s(84),s(81),s(79),s(77),s(74),s(72),s(69),s(67),s(65),s(62),s(60),s(59),s(58),s(57),s(56),s(55),s(54),s(53),s(52),s(51),s(50),s(49),s(48),s(47),s(46),s(45),s(44)])}static{this.SEMITONES=new Float32Array(w)}static{this.NOTES=o.SEMITONES}constructor(i){this.model=i,this.context=new AudioContext,this.voiceMix=this.context.createGain(),this.nextScheduleTime=0,this.absoluteTime=0,this.intervalId=-1,this.bpm=j;for(let e=0;e<=w;e++)o.SEMITONES[w-e]=s(e+57);if(this.buildFxChain(),this.context.state==="running")this.start();else{let e=document.querySelector("div.enabled-audio");e.style.visibility="visible";let t={capture:!0},n=a=>{e.style.visibility="hidden",a.preventDefault(),this.context.resume().then(()=>this.start()),window.removeEventListener("mousedown",n,t),window.removeEventListener("touchstart",n,t)};window.addEventListener("mousedown",n,t),window.addEventListener("touchstart",n,t)}}start(){-1<this.intervalId||(this.absoluteTime=0,this.nextScheduleTime=this.context.currentTime+o.LOOK_AHEAD_TIME,this.intervalId=setInterval(()=>{if(this.context.currentTime+o.LOOK_AHEAD_TIME>=this.nextScheduleTime){let e=this.absoluteTime,t=e+o.SCHEDULE_TIME,n=this.secondsToBars(e),a=this.secondsToBars(t);this.schedule(n,a),this.absoluteTime+=o.SCHEDULE_TIME,this.nextScheduleTime+=o.SCHEDULE_TIME}},1))}stop(){this.pause(),this.absoluteTime=0}pause(){this.intervalId!==-1&&(clearInterval(this.intervalId),this.intervalId=-1)}schedule(i,e){let t=i/o.SEMIQUAVER|0;if(t<0)return;let n=t*o.SEMIQUAVER;for(;n<e;){if(n>=i){let r=this.computeStartOffset(n),l=t&U;for(let h=0;h<16;h++)this.model.pattern.getStep(l,h)&&this.playVoice(r,h)}n=++t*o.SEMIQUAVER}let a=this.secondsToBars(this.absoluteTime+o.SCHEDULE_TIME);this.model.stepIndex=Math.floor(a/o.SEMIQUAVER)-1&U}computeStartOffset(i){return this.nextScheduleTime-this.absoluteTime+this.barsToSeconds(i)+o.ADDITIONAL_LATENCY}barsToSeconds(i){return i*240/this.bpm}secondsToBars(i){return i*this.bpm/240}playVoice(i,e){let t=this.context,n=i+o.RELEASE_TIME,a=t.createOscillator(),r=t.createGain(),l=t.createStereoPanner();l.pan.value=Math.random()-Math.random(),r.gain.value=o.VOICE_GAIN,r.gain.setValueAtTime(o.VOICE_GAIN,i),r.gain.linearRampToValueAtTime(0,n),a.frequency.value=o.NOTES[e],a.connect(l),l.connect(r),r.connect(this.voiceMix),a.start(i),a.stop(n)}buildFxChain(){let i=this.context.createDelay();i.delayTime.value=this.barsToSeconds(3/w);let e=this.context.createGain();e.gain.value=.4;let t=this.context.createGain();t.gain.value=.1,this.voiceMix.connect(i),i.connect(e),e.connect(i),e.connect(t),t.connect(this.context.destination)}};var z=(()=>{class o{constructor(){this.model=new I,this.audio=new O(this.model)}ngOnInit(){let e=document.querySelector("canvas#matrix");this.view=new A(this.model,e),location.hash!==""&&this.model.pattern.deserialize(location.hash.substring(1)),document.querySelector("button#link").onclick=n=>{n.preventDefault(),navigator.clipboard.writeText(`https://rostag.github.io/tonematrix/#${this.model.pattern.serialize()}`)},document.querySelector("button#studio").onclick=n=>{n.preventDefault(),window.open("https://www.audiotool.com/")},document.addEventListener("touchmove",n=>n.preventDefault(),{passive:!1}),document.addEventListener("dblclick",n=>n.preventDefault(),{passive:!1});let t=()=>document.body.style.height=`${window.innerHeight}px`;window.addEventListener("resize",t),t(),requestAnimationFrame(()=>{document.querySelectorAll("body svg.preloader").forEach(n=>n.remove()),document.querySelectorAll("body main").forEach(n=>n.classList.remove("invisible"))})}static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275cmp=R({type:o,selectors:[["app-tonematrix"]],standalone:!1,decls:15,vars:0,consts:[[1,"matrix-wrap"],[1,"enabled-audio"],["id","matrix"],[1,"tone-footer"],["id","link"],["id","studio"],[1,"copy"],["href","https://andremichelle.github.io/tonematrix/"]],template:function(t,n){t&1&&(f(0,"div",0)(1,"div",1),v(2,"CLICK TO RUN AUDIO"),E(),f(3,"div"),D(4,"canvas",2),f(5,"footer",3)(6,"button",4),v(7,"Copy Link"),E(),f(8,"button",5),v(9,"Open Audiotool Studio"),E()()(),f(10,"div",6),v(11,"Ported to Angular from original"),D(12,"br"),f(13,"a",7),v(14,"Tonematrix by Andre Michelle"),E()()())},styles:["[_nghost-%COMP%]{--color: #2A2A2A;--background-color: black;margin:0;padding:16px;overflow:hidden;position:relative;font-family:Open Sans,sans-serif;-webkit-overflow-scrolling:touch;touch-action:manipulation;color:var(--color);background-color:var(--background-color);width:-webkit-fill-available;height:-webkit-fill-available;display:flex;align-items:center;justify-content:center;min-width:100vw;min-height:100vh;min-width:-webkit-fill-available}*[_ngcontent-%COMP%]{user-select:none;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-tap-highlight-color:transparent}.hidden[_ngcontent-%COMP%]{display:none!important}.invisible[_ngcontent-%COMP%]{visibility:hidden!important}.enabled-audio[_ngcontent-%COMP%]{top:16px;text-align:center}canvas[_ngcontent-%COMP%]{width:min(512px,80vmin);height:min(512px,80vmin);filter:blur(1px);position:relative}.tone-footer[_ngcontent-%COMP%]{margin-top:16px;display:flex;justify-content:space-between}.tone-footer[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{color:inherit;border:none;outline:none;appearance:none;padding:8px;cursor:pointer;background-color:#666;border-radius:1px}footer[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:active{background-color:#0ff}.copy[_ngcontent-%COMP%]{font-size:.6rem;color:#555;text-align:center}.copy[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#999}  .app-footer{display:none}"]})}}return o})();var Q=[{path:"",component:z}],H=(()=>{class o{static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275mod=b({type:o})}static{this.\u0275inj=T({imports:[L.forChild(Q),L]})}}return o})();var dt=(()=>{class o{static{this.\u0275fac=function(t){return new(t||o)}}static{this.\u0275mod=b({type:o})}static{this.\u0275inj=T({imports:[P,H]})}}return o})();export{dt as TonematrixModule};
